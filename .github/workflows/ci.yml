name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install project requirements if present
          if [ -f combined_nim_owlban_ai/requirements.txt ]; then pip install -r combined_nim_owlban_ai/requirements.txt; fi
          pip install flake8 pytest pylint mypy

      - name: Run flake8 (project scope)
        run: |
          # Limit linting to main python packages to avoid third-party recursion issues
          flake8 combined_nim_owlban_ai new_products || true

      - name: Run pylint (project scope)
        run: |
          # Run pylint on main packages with reasonable settings
          pylint --disable=C0103,C0114,C0115,C0116,W0613,R0903,R0913,R0914,R0915 combined_nim_owlban_ai new_products || true

      - name: Run mypy (project scope)
        run: |
          # Run mypy on main packages with reasonable settings
          mypy --ignore-missing-imports combined_nim_owlban_ai new_products || true

      - name: Run tests (if present)
        run: |
          if [ -d tests ] || ls test_*.py 1>/dev/null 2>&1 || ls *_test.py 1>/dev/null 2>&1; then
            pytest -q
          else
            echo "No tests found; skipping pytest"
          fi

      - name: Run E2E smoke (registration)
        run: |
          # Run a quick smoke to ensure the E2E script runs (it writes a report file)
          python nvidia_partner_registration_e2e.py

      - name: Upload registration report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nvidia-registration-report
          path: nvidia_registration_completion_report.md
